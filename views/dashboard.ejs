<!DOCTYPE html>
<html>

<head>
	<title>Password Manager - Dashboard</title>
	<link rel='stylesheet' href="https://fonts.googleapis.com/css?family=Bungee">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Russo+One">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.4/font/bootstrap-icons.css">
	<link rel='stylesheet' href='/stylesheets/style.css' />
	<script>
		function generate() {
			var alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
			var allSymbols = "!*.-_$/&%?,;:+";
			const length = document.querySelector("#lengthSpinner").value;

			const pwd_field = document.querySelector("#pwd");
			const options = [
				document.querySelector("#uppercaseCb").checked,
				document.querySelector("#lowercaseCb").checked,
				document.querySelector("#numbersCb").checked,
				document.querySelector("#symbolsCb").checked
			];
			
			const probabilities = [0.45, 0.45, 0.05, 0.05];
			var sum = 0, remaining = 0;
			for (let i = 0; i < probabilities.length; i++) {
				if (!options[i])
					probabilities[i] = 0;
				else {
					sum += probabilities[i];
					remaining++;
				}
			}

			const logLabel = document.querySelector("#logLabel");
			logLabel.innerHTML = "";
			if (remaining == 0) {
				logLabel.innerHTML = "Seleziona almeno un'opzione!";
				logLabel.style = "color: red;";
				return;
			}

			var fraction = (1-sum)/remaining;
			var increaseAmts = [];
			for (let i = 0; i < probabilities.length; i++) {
				var incAmt;
				if (options[i]) {
					probabilities[i] += fraction;
					incAmt = (1-probabilities[i])/(length-1);
				} else incAmt = 0;
				increaseAmts.push(incAmt);
			}

			pwd_field.value = "";
			for (var i = 0; i < length; i++) {
				var index = -1;
				for (let j = 0; j < probabilities.length; j++)
					if (options[j] && (index == -1 || probabilities[j] > probabilities[index]))
						index = j;

				var char;
				if (index <= 1) {
					char = alphabet[Math.floor(Math.random() * alphabet.length)];
					if (index == 1)
						char = char.toLowerCase();
				} else if (index == 2)
					char = Math.floor(Math.random() * 10);
				else char = allSymbols[Math.floor(Math.random() * allSymbols.length)];
				
				probabilities[index] = 0;
				for (let j = 0; j < probabilities.length; j++)
					if (j != index)
						probabilities[j] += increaseAmts[j];
				pwd_field.value += char;
			}
		}

		function togglePwdVisibility() {
			const pwdField = document.querySelector("#pwd");
			const eyeBtn = document.querySelector("#eyeBtn");

			if (pwdField.getAttribute("type") == "password") {
				pwdField.setAttribute("type", "text");
				eyeBtn.setAttribute("class", "bi bi-eye-slash-fill");
			} else {
				pwdField.setAttribute("type", "password");
				eyeBtn.setAttribute("class", "bi bi-eye-fill");
			}
		}

		function load() {
			var success = "<%= success %>"
			var label = document.querySelector("#logLabel");
			if (success == 1) {
				label.innerHTML = "Password creata!";
				label.setAttribute("style", "color: green;");
			} else if (success == -1) {
				label.innerHTML = "Password non creata!";
				label.setAttribute("style", "color: red;");
			}

			showHidePasswordMaker();
		}

		function showHidePasswordMaker() {
			var menu = document.getElementById("pwd-maker-form");
			menu.classList.toggle("show");

			var listener = () => {
				menu.setAttribute("style", "position: absolute; visibility: hidden;");
				menu.removeEventListener("transitionend", listener);
			};

			if (!menu.classList.contains("show"))
				menu.addEventListener("transitionend", listener);
			else menu.setAttribute("style", "position: relative; visibility: visible;");

			document.getElementById("pm-header-arrow").classList.toggle("open");
		}

		function showHidePasswords() {
			document.getElementById("stored-pwd-list").classList.toggle("show");
			document.getElementById("sp-header-arrow").classList.toggle("open");
		}
	</script>
</head>
<body onload="load()">
	<div>
		<div class="header">
			<h1>Crea una nuova password</h1>
			<i id="pm-header-arrow" class="bi bi-chevron-up" onclick="showHidePasswordMaker()"></i>
		</div>
		<form id="pwd-maker-form" class="menu" action="/dashboard" method="POST" name="form">
			<input type="text" id="account" class="text-field" name="account" placeholder="Account" required />
			<div class="pwd-input-container">
				<input type="password" id="pwd" class="pwd-field" name="password" placeholder="Password" required />
				<i id="eyeBtn" class="bi bi-eye-fill" onclick="togglePwdVisibility()"></i>
			</div>
			<input type="submit" id="submitBtn" value="Crea" />
			<label id="logLabel"></label>
			<table id="pwdOptions">
				<tr>
					<td id="labeledCb">
						<input type="checkbox" id="uppercaseCb" checked="true" value="ciao" />
						<label for="uppercaseCb">Lettere maiuscole</label>
					</td>
					<td id="labeledCb">
						<input type="checkbox" id="lowercaseCb" checked="true" />
						<label for="lowercaseCb">Lettere minuscole</label>
					</td>
				</tr>
				<tr>
					<td id="labeledCb">
						<input type="checkbox" id="numbersCb" checked="true" />
						<label for="numbersCb">Numeri</label>
					</td>
					<td id="labeledCb">
						<input type="checkbox" id="symbolsCb" checked="true" />
						<label for="symbolsCb">Simboli</label>
					</td>
				</tr>
			</table>
			<div id="labeledSpinner">
				<label for="lengthSpinner">Lunghezza:</label>
				<input type="number" id="lengthSpinner" min="4" max="24" step="1" value="10" />
			</div>
			<input type="button" id="generatePwdBtn" onclick="generate();" value="Genera" />
		</form>
	</div>
	<div>
		<div class="header">
			<h1>Password salvate</h1>
			<i id="sp-header-arrow" class="bi bi-chevron-up" onclick="showHidePasswords()"></i>
		</div>
		<div id="stored-pwd-list" class="menu">
			<% passwords.forEach(pwd => { %>
				<div id="storedPwd" class="storedPwd">
					<h2>Account: <%=pwd.account%></h2>
					<h2>Password: <%=pwd.password%> <i class="bi bi-clipboard"></i></a></h2>
				</div>
			<%})%>
		</div>
	</div>
</body>
</html>